name: Sync Examples to Pollyweb

on:
  release:
    types: [published]

jobs:
  sync-examples:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pollywog
        uses: actions/checkout@v5
        with:
          path: pollywog

      - name: Checkout pollyweb
        uses: actions/checkout@v5
        with:
          repository: endarthur/pollyweb
          token: ${{ secrets.POLLYWEB_PUSH_TOKEN }}
          path: pollyweb

      - name: Copy examples to pollyweb
        run: |
          rm -rf pollyweb/content/examples
          cp -r pollywog/examples pollyweb/content/examples

      - name: Copy quickstart notebook to pollyweb root
        run: |
          cp pollywog/examples/jupyterlite_quickstart.ipynb pollyweb/content/quickstart.ipynb

      - name: Update pollyweb requirements.txt with released version
        run: |
          cd pollyweb
          # Update lf_pollywog version in requirements.txt
          sed -i 's/^# *lf_pollywog.*/lf_pollywog==${{ github.event.release.tag_name }}/' requirements.txt
          # If not found, add it after scikit-learn
          grep -q "^lf_pollywog" requirements.txt || sed -i '/scikit-learn/a lf_pollywog==${{ github.event.release.tag_name }}' requirements.txt

      - name: Set up git
        run: |
          cd pollyweb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch, commit, and push
        run: |
          cd pollyweb
          git checkout -b update-from-pollywog-${{ github.event.release.tag_name }}
          git add content/examples
          git add content/quickstart.ipynb
          git add requirements.txt
          git status
          git diff --staged
          git commit -m "Update from pollywog ${{ github.event.release.tag_name }}

          - Updated example notebooks
          - Using lf_pollywog==${{ github.event.release.tag_name }} from PyPI
          - No longer copying pollywog folder"
          git push origin update-from-pollywog-${{ github.event.release.tag_name }}

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh

      - name: Create Pull Request
        run: |
          cd pollyweb
          gh pr create --title "Update from pollywog ${{ github.event.release.tag_name }}" \
            --body "$(cat <<'EOF'
          Automated sync from pollywog release ${{ github.event.release.tag_name }}

          ## Changes
          - ✅ Updated example notebooks
          - ✅ Using lf_pollywog==${{ github.event.release.tag_name }} from PyPI
          - ❌ No longer copying pollywog folder directly

          The examples now assume pollywog is properly installed and available via import.
          EOF
          )" \
            --base main \
            --head update-from-pollywog-${{ github.event.release.tag_name }}
        env:
          GH_TOKEN: ${{ secrets.POLLYWEB_PUSH_TOKEN }}
