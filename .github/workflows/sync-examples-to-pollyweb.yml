name: Sync Examples to Pollyweb

on:
  release:
    types: [published]

jobs:
  sync-examples:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pollywog
        uses: actions/checkout@v4
        with:
          path: pollywog

      - name: Checkout pollyweb
        uses: actions/checkout@v4
        with:
          repository: endarthur/pollyweb
          token: ${{ secrets.POLLYWEB_PUSH_TOKEN }}
          path: pollyweb

      - name: Copy examples to pollyweb
        run: |
          rm -rf pollyweb/content/examples
          cp -r pollywog/examples pollyweb/content/examples

      - name: Copy pollywog package to pollyweb
        run: |
          rm -rf pollyweb/content/pollywog
          cp -r pollywog/pollywog pollyweb/content/pollywog

      - name: Copy and rename quickstart notebook to pollyweb root
        run: |
          cp pollywog/examples/jupyterlite_quickstart.ipynb pollyweb/content/quickstart.ipynb

      - name: Set up git
        run: |
          cd pollyweb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch, commit, and push
        run: |
          cd pollyweb
          git checkout -b update-examples-${{ github.event.release.tag_name }}
          git add content/examples
          git add content/pollywog
          git add content/quickstart.ipynb
          git status
          git commit -m "Update examples from pollywog ${{ github.event.release.tag_name }}"
          git push origin update-examples-${{ github.event.release.tag_name }}

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install gh

      - name: Create Pull Request
        run: |
          cd pollyweb
          gh pr create --title "Update examples from pollywog ${{ github.event.release.tag_name }}" \
            --body "Automated sync of examples from pollywog release ${{ github.event.release.tag_name }}" \
            --base main \
            --head update-examples-${{ github.event.release.tag_name }}
        env:
          GH_TOKEN: ${{ secrets.POLLYWEB_PUSH_TOKEN }}
